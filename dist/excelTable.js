"use strict";angular.module("excel-table",["ui.bootstrap","ngSanitize"]).factory("excelTableModel",function(){var e=null,t=null,a=null,i=null;return{setDataModel:function(t){e=t},getDataModel:function(){return e},setModel:function(e){e=e},getModel:function(){return t},setPredicate:function(e){e=e},getPredicate:function(){return a},setReverse:function(e){e=e},getReverse:function(){return i}}}).filter("startFrom",function(){return function(e,t){return e?(t=+t,e.slice(t)):[]}}).directive("tbCell",["$window","excelTableModel",function(e,t){return{restrict:"A",link:function(e,t,a){t.on("mouseover",function(){if(-1!=a["class"].indexOf("row-"))for(var e=document.getElementsByClassName(a["class"]),t=e.length,i=0;t>i;i++)e[i].className+=" row-hover"}),t.on("mouseout",function(){if(-1!=a["class"].indexOf("row-"))for(var e=document.getElementsByClassName(a["class"]),t=e.length,i=0;t>i;i++)e[i].className=e[i].className.replace(" row-hover","")}),e.editRow=function(t){e.$emit("editRow",t)},t.on("click",function(){if(-1!=a["class"].indexOf("sortable")){if(void 0!=e.recordEditing)return!1;var i=!0,n=document.getElementsByClassName("sortable"),o=t[0].querySelector(".fa"),l=t[0].className.substring(t[0].className.indexOf("col-")+4,t[0].className.indexOf(" ng-class"));if(void 0==o)return!1;for(var r=0;r<n.length;r++)n[r].className=n[r].className.replace(" active","");t[0].className+=" active",-1==o.className.indexOf("desc")?(o.className=o.className.replace("asc","desc"),i=!1):(o.className=o.className.replace("desc","asc"),i=!0),e.order(l,i)}})}}}]).directive("compileHtml",["$compile",function(e){return function(t,a,i){t.$watch(function(e){return e.$eval(i.compileHtml)},function(i){a.html(i),e(a.contents())(t)})}}]).directive("excelTable",["$compile","$filter","excelTableModel","$http","$rootScope","$sanitize",function(e,t,a,i,n,o){return{scope:{model:"=model",data:"=data",tableOption:"=tblOption"},restrict:"E",templateUrl:"template/table.html",link:function(e,o,l){if(e.cellFilter={},e.dataParams={},e.totalWidth="100%",e.tblDefaultOptions={type:"local",forceFit:!0,allowPaging:!1,allowFilter:!1,dblClickToEdit:!0,rud:{read:void 0,update:void 0},pagingOption:void 0},Object.keys(e.tblDefaultOptions).map(function(t,a){void 0!=e.tableOption&&(e.tblDefaultOptions[t]=e.tableOption[t])}),e.tableOption=e.tblDefaultOptions,o.bind("scroll",function(){this.querySelector(".ctrl-panel-wrapper").style.left=this.offsetWidth/2-100+this.scrollLeft+"px"}),e.tableOption.forceFit){for(var r=0,s=0;s<e.model.length;s++)r+=e.model[s].width;for(var s=0;s<e.model.length;s++)e.model[s].width=e.model[s].width/r*100+"%"}else{for(var r=0,s=0;s<e.model.length;s++)r+=e.model[s].width,e.model[s].width=e.model[s].width+"px";e.totalWidth=r+2+"px"}var c=t("orderBy");e.order=function(t,a){"remote"==e.tableOption.type?(e.predicate=t,e.dataParams.sorting={sortBy:t,ascending:a},e.getRecords()):(e.predicate=t,e.data=c(e.data,t,!a),e.$apply())},e.getRecords=function(){var t={method:"POST",withCredentials:!0,url:e.tableOption.rud.read};"remote"==e.tableOption.type&&(t.data=e.dataParams),i(t).then(function(t){e.data=t.data.data,e.tableOption.allowPaging&&(e.paging.totalItems=t.data.totalItems)},function(e){console.log(e)})},n.$on("rowEditing",function(t,a){e.recordEditing=a}),a.setModel(e.model),a.setDataModel(e.data),e.primaryKey=l.primary,e.tableOption.allowPaging?(e.paging={currentPage:1,totalItems:void 0,pagingSize:void 0,itemsPerPage:5,boundaryLinks:!1,boundaryLinkNumbers:!1,rotate:!0,directionLinks:!0,firstText:"First",previousText:"Previous",nextText:"Next",lastText:"Last",forceEllipses:!1},Object.keys(e.paging).map(function(t,a){void 0!=e.tableOption.pagingOption[t]&&(e.paging[t]=e.tableOption.pagingOption[t])}),e.dataParams.paging={start:0,limit:e.paging.itemsPerPage},e.getRecords(),e.pageChanged=function(){"remote"==e.tableOption.type&&(e.dataParams.paging.start=(e.paging.currentPage-1)*e.paging.itemsPerPage,e.getRecords())},e.updateTableData=function(){return void 0!=e.recordEditing?!1:void("remote"==e.tableOption.type&&(e.paging.currentPage=1,e.dataParams.paging.start=0,e.dataParams.paging.limit=e.paging.itemsPerPage,e.getRecords()))}):e.getRecords(),e.$watch("cellFilter",function(a,i){"remote"==e.tableOption.type?(e.paging.currentPage=1,e.dataParams.search=a,e.getRecords()):(e.filtered=t("filter")(e.data,a),void 0!=e.filtered&&void 0!=e.paging&&(e.paging.totalItems=e.filtered.length,e.currentPage=1))},!0)}}}]);