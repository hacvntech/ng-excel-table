"use strict";angular.module("excel-table",["ui.bootstrap"]).factory("excelTableModel",function(){var e=null,t=null,a=null,r=null;return{setDataModel:function(t){e=t},getDataModel:function(){return e},setModel:function(e){e=e},getModel:function(){return t},setPredicate:function(e){e=e},getPredicate:function(){return a},setReverse:function(e){e=e},getReverse:function(){return r}}}).filter("startFrom",function(){return function(e,t){return e?(t=+t,e.slice(t)):[]}}).directive("tbCell",["$window","excelTableModel","$timeout",function(e,t,a){return{restrict:"A",link:function(e,t,r){e.$watch(function(){return t.height()},function(e,r){a(function(){if(-1!=t.attr("class").indexOf("tb-row tb-cell row-")&&-1==t.attr("class").indexOf("tb-row tb-cell row-{{$index+1}}-{{tableId}}")){for(var e=document.getElementsByClassName(t.attr("class")),a=0,r=0;r<e.length;r++)a<e[r].offsetHeight&&(a=e[r].offsetHeight);for(var r=0;r<e.length;r++)e[r]!=t[0]&&(e[r].style.height=a+"px")}if(-1!=t.attr("class").indexOf("table-header-container")){for(var e=document.getElementsByClassName(t.attr("class")),a=0,r=0;r<e.length;r++)a<e[r].offsetHeight&&(a=e[r].offsetHeight);for(var r=0;r<e.length;r++)e[r]!=t[0]&&(e[r].style.height=a+"px")}})}),t.on("mouseover",function(){if(-1!=r["class"].indexOf("row-"))for(var e=document.getElementsByClassName(r["class"]),t=e.length,a=0;t>a;a++)e[a].className+=" row-hover"}),t.on("mouseout",function(){if(-1!=r["class"].indexOf("row-"))for(var e=document.getElementsByClassName(r["class"]),t=e.length,a=0;t>a;a++)e[a].className=e[a].className.replace(" row-hover","")}),e.editRow=function(t){e.$emit("editRow",t)},t.on("click",function(){if(-1!=t[0].className.indexOf("sortable")){if(void 0!=e.recordEditing)return!1;var a=!0,o=document.getElementsByClassName("sortable"),i=t[0].querySelector(".fa"),n=r.column;if(void 0==i)return!1;for(var l=0;l<o.length;l++)o[l].className=o[l].className.replace(" active","");t[0].className+=" active",-1==i.className.indexOf("desc")?(i.className=i.className.replace("asc","desc"),a=!1):(i.className=i.className.replace("desc","asc"),a=!0),e.order(n,a)}})}}}]).directive("compileHtml",["$compile",function(e){return function(t,a,r){t.$watch(function(e){return e.$eval(r.compileHtml)},function(r){a.html(r),e(a.contents())(t)})}}]).directive("excelTable",["$compile","$filter","excelTableModel","$http","$rootScope",function(e,t,a,r,o){return{scope:{model:"=model",data:"=data",tableOption:"=tblOption"},restrict:"E",templateUrl:"template/table.html",link:function(e,i,n){e.tableId="xtable-"+n.id,e.cellFilter={},e.dataParams={start:0,length:0,sort:{predicate:"",order:"ASC"},search:{}},e.totalWidth="100%",e.tblDefaultOptions={type:"local",forceFit:!0,allowPaging:!1,allowFilter:!1,dblClickToEdit:!0,rud:{customScopeParams:void 0,read:void 0,update:void 0},pagingOption:void 0},Object.keys(e.tblDefaultOptions).map(function(t,a){void 0!=e.tableOption&&(e.tblDefaultOptions[t]=e.tableOption[t])}),e.tableOption=e.tblDefaultOptions,i.bind("scroll",function(){this.querySelector(".ctrl-panel-wrapper").style.left=this.offsetWidth/2-100+this.scrollLeft+"px"}),e.recursiveGroupHeader=function(t){for(var a=t.items,r=0,o=0;o<a.length;o++)r+=void 0!=a[o].items?e.recursiveGroupHeader(a[o]):a[o].width;return t.width=r,r},e.recursiveModelGroupHeader=function(t,a,r){for(var o=t.items,i=0;i<o.length;i++)void 0!=o[i].items?e.recursiveModelGroupHeader(o[i],a,r+1):e.tableOption.forceFit?o[i].width=o[i].width/t.width*100+"%":o[i].width=o[i].width-(i==o.length-1?r+1:0)+"px";e.tableOption.forceFit?t.width=t.width/a*100+"%":t.width=t.width-1+"px"};for(var l=0,d=0;d<e.model.length;d++)void 0!=e.model[d].items?l+=e.recursiveGroupHeader(e.model[d]):(e.tableOption.forceFit||(e.model[d].width+="px"),l+=parseFloat(e.model[d].width));for(var d=0;d<e.model.length;d++)void 0!=e.model[d].items?e.recursiveModelGroupHeader(e.model[d],l,0):e.tableOption.forceFit&&(e.model[d].width=e.model[d].width/l*100+"%");e.tableOption.forceFit||(e.totalWidth=l+1+"px",i.width(e.totalWidth));var s=t("orderBy");e.order=function(t,a){"remote"==e.tableOption.rud.read.type?(e.predicate=t,e.dataParams.sort={predicate:t,order:a?"ASC":"DESC"},e.getRecords()):(e.predicate=t,e.data=s(e.data,t,!a),e.$apply())},e.getRecords=function(){var t={url:e.tableOption.rud.read.url,method:e.tableOption.rud.read.method,withCredentials:void 0==e.tableOption.rud.credentials?!1:e.tableOption.rud.credentials,header:e.tableOption.rud.header};"remote"==e.tableOption.rud.read.type&&(t.data=e.tableOption.rud.read.data,void 0!=t.data[e.tableOption.rud.customScopeParams]?Object.keys(e.dataParams).map(function(a,r){void 0!=t.data[e.tableOption.rud.customScopeParams][a]&&(t.data[e.tableOption.rud.customScopeParams][a]=e.dataParams[a])}):t.data[e.tableOption.rud.customScopeParams]=e.dataParams),r(t).then(function(t){e.data=t.data.data,e.tableOption.allowPaging&&(e.paging.totalItems=t.data.totalItems),"function"==typeof e.tableOption.rud.read.fn.success&&e.tableOption.rud.read.fn.success(t)},function(t){"function"==typeof e.tableOption.rud.read.fn.success&&e.tableOption.rud.read.fn.failure(t)})},o.$on("rowEditing",function(t,a){e.recordEditing=a}),a.setModel(e.model),a.setDataModel(e.data),e.primaryKey=n.primary,e.tableOption.allowPaging?(e.paging={currentPage:1,totalItems:void 0,pagingSize:void 0,itemsPerPage:5,boundaryLinks:!1,boundaryLinkNumbers:!1,rotate:!0,directionLinks:!0,firstText:"First",previousText:"Previous",nextText:"Next",lastText:"Last",forceEllipses:!1},Object.keys(e.paging).map(function(t,a){void 0!=e.tableOption.pagingOption[t]&&(e.paging[t]=e.tableOption.pagingOption[t])}),e.dataParams.start=0,e.dataParams.length=e.paging.itemsPerPage,e.getRecords(),e.pageChanged=function(){"remote"==e.tableOption.rud.read.type&&(e.dataParams.start=(e.paging.currentPage-1)*e.paging.itemsPerPage,e.getRecords())},e.updateTableData=function(){return void 0!=e.recordEditing?!1:void("remote"==e.tableOption.rud.read.type&&(e.paging.currentPage=1,e.dataParams.start=0,e.dataParams.length=e.paging.itemsPerPage,e.getRecords()))}):e.getRecords(),e.$watch("cellFilter",function(a,r){"remote"==e.tableOption.rud.read.type?(e.paging.currentPage=1,e.dataParams.search=a,e.getRecords()):(e.filtered=t("filter")(e.data,a),void 0!=e.filtered&&void 0!=e.paging&&(e.paging.totalItems=e.filtered.length,e.currentPage=1))},!0)}}}]).run(["$templateCache",function(e){}]);